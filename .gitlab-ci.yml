---

image: nikolaik/python-nodejs:python3.7-nodejs12

services:
  - postgres:12

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POETRY_VIRTUALENVS_PATH: "$CI_PROJECT_DIR/.cache/venvs"
  POSTGRES_DB: ovino
  POSTGRES_USER: ovino
  POSTGRES_PASSWORD: unsafe-password-for-testing
  DATABASE_URL: postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres/$POSTGRES_DB
  SECRET_KEY: unsafe-key-for-testing


stages:
  - testing
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip/
    - .cache/venvs/

default:
  before_script:
    - pip install poetry==1.0.5
    - poetry install

lint:
  stage: testing
  script:
    - poetry run black --check backend tests
    - poetry run isort -rc backend tests
    - poetry run flake8 backend tests
    - poetry run bandit --quiet --recursive backend

test:
  stage: testing
  coverage: '/TOTAL.*\s+(\d+%)$/'
  script:
    - poetry run pytest --cov=backend

deploy_prod_backend:
  stage: deploy
  only:
    - master
  image: ilyasemenov/gitlab-ci-git-push
  before_script: []
  cache: {}
  script:
    - git-push ssh://dokku@app2.fabricadesoftware.ifc.edu.br:1022/ovino-backend

deploy_prod_frontend:
  stage: deploy
  only:
    - master
  image: ilyasemenov/gitlab-ci-git-push
  before_script: []
  cache: {}
  script:
    - git-push ssh://dokku@app2.fabricadesoftware.ifc.edu.br:1022/ovino-frontend
  environment:
    name: prod
    url: https://ovino.fabricadesoftware.ifc.edu.br
